<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <title>ThingSpeak IoT Cloud</title>  <!Page title>

  <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
          crossorigin="anonymous">


    <style>
        .top-buffer {
            margin-top: 40px;
        }
    </style>



    <script>

        let Channel_1_ContactorStatus = 0;

        setTimeout(Init, 2);// Required to intialize the button depending on the switch status, only ONCE

        setInterval(ReadThingSpeakAPI, 1000);// Event driven REPEAT timer for fetching the data from the ThingSpeak

        function Init() {
            ReadThingSpeakAPI();
            ButtonEnableDisable();
        }

        function ButtonEnableDisable() {
            if (Channel_1_ContactorStatus == 0) {
                document.getElementById("offbtn").disabled = false;// enables the OFF button
                document.getElementById("onbtn").disabled = true;// disables the ON button
            } else if (Channel_1_ContactorStatus == 1) {
                document.getElementById("onbtn").disabled = false;// enables the ON button
                document.getElementById("offbtn").disabled = true;// disables the OFF button
            }
        }

        function ReadThingSpeakAPI() {
            fetch('https://api.thingspeak.com/channels/1371638/feeds.json?api_key=6JM5T4GQ0TCFSGFT&results=2')
                .then(response => response.text())
                .then(data => {
                        const obj = JSON.parse(data);   // Accessing individual value from JS object
                        //  document.getElementById("txPowerStatus").innerHTML = obj["feeds"][1]["field2"];
                    //    console.log(data);
                        Channel_1_ContactorStatus = obj["feeds"][1]["field2"];// status of the power contactor
                    //    console.log(Channel_1_ContactorStatus);

                        if (Channel_1_ContactorStatus == 1) document.getElementById("txPowerStatus").innerHTML = "Transmitter is OFF";
                        else if (Channel_1_ContactorStatus == 0) document.getElementById("txPowerStatus").innerHTML = "Transmitter is ON";

                        var Temp1 = obj["feeds"][1]["field3"];
                        var Temp11 = Math.round((Temp1*100000)/100000);
                        var Temp3 = " C";
                        var Temp1 = Temp11 + " " + Temp3;
                        if(Temp11 == 0)Temp1 = "";

                        var Temp2 = obj["feeds"][1]["field4"];
                        var Temp22 = Math.round((Temp2*100000)/100000);
                        var Temp3 = " %";
                        var Temp2 = Temp22 + " " + Temp3;
                        if(Temp22 == 0)Temp2 = "";

                        document.getElementById("tempStatus").innerHTML = Temp1;
                        document.getElementById("rhStatus").innerHTML = Temp2;

                        ButtonEnableDisable();
                    }
                )
        }


        ///////////////////////Writing to ThingSpeak////////////////////////////

        function TxSwitchON() {
            API_TX_Switch(0);
        }

        function TxSwitchOFF() {
            API_TX_Switch(1);
        }

        function API_TX_Switch(onOrOff) {
            fetch(`https://api.thingspeak.com/update?api_key=FYHD918T4ZH50R1A&field1=${onOrOff}`)
                .then(response => response.text())
                .then(data => {
                        // document.getElementById("txPowerStatus").innerHTML = data;
                      //   console.log(data);
                        if (data == 0) alert("Command failed.  Retry once again after 20 seconds");
                          else alert("Command Success!! Wait for 20 seconds for the switching to take place")
                    }
                )
                .catch((error) => {
                        console.error('Error:', error);
                    }
                );

        }

  function GraphicsWindow(){
    window.location.href='https://thingspeak.com/apps/matlab_visualizations/412315?width=1000&height=600'
  }


    </script>
</head>



<body class="d-flex flex-column min-vh-100">  <! Creates heading for the page>

<div class="container">


    <div class="row top-buffer">
        <div class="col">
            <h1 class="display-4 text-center">Transmitter Automation</h1>
            <h1 class="display-6 text-center">IoT Cloud Application using ThingSpeak platform</h1>
        </div>
    </div>



    <div class="row top-buffer"> <! Creates buttons for the switching>
        <div class="col">
            <div class="d-grid gap-4 col-3 mx-auto">
                <button id="onbtn" type="button" class="btn btn-primary" disabled onclick={TxSwitchON(this)}>TURN
                    Transmitter ON
                </button>
                <button id="offbtn" type="button" class="btn btn-primary" disabled onclick={TxSwitchOFF(this)}>TURN
                    Transmitter OFF
                </button>
            </div>
        </div>
    </div>




    <div class="row top-buffer { margin-top:30px; }">  <!Creates table for the the text display>
        <div class="col"></div>
        <div class="col">
            <table class="table">
                <tbody>
                <tr class="table-danger"> <! changes the color fill in the field>
                    <th scope="row">Transmitter Status:</th>
                    <td id="txPowerStatus"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="col"></div>
    </div>
</div>


<div class="row top-buffer">  <!Creates table for the the text display>
    <div class="col"></div>
    <div class="col">
        <table class="table">
            <tbody>
            <tr class="table-info">
                <th scope="row">Ambient Temperature:</th>
                <td id="tempStatus"></td>
            </tr>
            <tr class="table-info">
                <th scope="row">Relative Humidity:</th>
                <td id="rhStatus"></td>
            </tr>

            </tbody>
        </table>
    </div>
    <div class="col"></div>
</div>
</div>



<div class="row top"> <! Creates button for the Matlab graphics>

    <div class="col">
        <div class="d-grid gap-4 col-4 mx-auto">

          <button class="btn btn-success" onclick=GraphicsWindow()>
            Graphics on Temperature/RH vs Time.
          </button>



        </div>
    </div>
</div>




<footer class="footer py-3 bg-light mt-auto">
    <div class="container text-center">
        <span class="text-muted">Built by Varpas Media Technologies Pvt Ltd</span>
    </div>
</footer>
</body>
</html>
