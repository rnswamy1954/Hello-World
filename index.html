<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <title>ThingSpeak IoT Cloud</title>  <!Page title>

  <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
          crossorigin="anonymous">


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> <! For Modals>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Stylesheet -->
<link href="bootstrap.min.css" rel="stylesheet">
<link href="fs-modal.min.css" rel="stylesheet">




    <style>
        .top-buffer {
            margin-top: 40px;
        }

        .modal-dialog iframe{
            margin: 0 auto;
            display: block;
        }
    </style>


    <script>  /* Graphics on Temp and RH: Get iframe src attribute value i.e. Matlab graphics URL and store it in a variable */
    $(document).ready(function(){

        var url = $("#TempRHGraphics").attr('src');

        /* Assign empty url value to the iframe src attribute when modal hide, which stop the video playing */
        $("#TempRHModal").on('hide.bs.modal', function(){
            $("#TempRHGraphics").attr('src', '');
        });

        /* Assign the initially stored url back to the iframe src attribute when modal is displayed again */
        $("#TempRHModal").on('show.bs.modal', function(){
            $("#TempRHGraphics").attr('src', url);
        });
    });


    /*Graphics on Transmitter switching: Get iframe src attribute value i.e. Matlab graphics URLand store it in a variable */
    $(document).ready(function(){

        var url = $("#TxSwitchingGraphics").attr('src');

        /* Assign empty url value to the iframe src attribute when modal hide, which stop the video playing */
        $("#TxSwitchingModal").on('hide.bs.modal', function(){
            $("#TxSwitchingGraphics").attr('src', '');
        });

        /* Assign the initially stored url back to the iframe srcatribute when modal is displayed again */
        $("#TxSwitchingModal").on('show.bs.modal', function(){
            $("#TxSwitchingGraphics").attr('src', url);
        });
    });

        let Channel_1_ContactorStatus = 0;

        setTimeout(Init, 2);// Required to intialize the Tx Button depending on the switch status, only ONCE when the app is opened
        function Init()
        {
            ReadThingSpeakAPI();
            ButtonEnableDisable();
           }

        setInterval(ReadThingSpeakAPI, 1000);// Event driven REPEAT timer for fetching the data from the ThingSpeak


        function ButtonEnableDisable() {
            if (Channel_1_ContactorStatus == 0) {
                document.getElementById("offbtn").disabled = false;// enables the OFF button
                document.getElementById("onbtn").disabled = true;// disables the ON button
            } else if (Channel_1_ContactorStatus == 1) {
                document.getElementById("onbtn").disabled = false;// enables the ON button
                document.getElementById("offbtn").disabled = true;// disables the OFF button
            }
        }

        function ReadThingSpeakAPI() {
            fetch('https://api.thingspeak.com/channels/1371638/feeds.json?api_key=6JM5T4GQ0TCFSGFT&results=2')
                .then(response => response.text())
                .then(data => {
                        const obj = JSON.parse(data);   // Accessing individual value from JS object
                        //  document.getElementById("txPowerStatus").innerHTML = obj["feeds"][1]["field2"];
                    //    console.log(data);
                        Channel_1_ContactorStatus = obj["feeds"][1]["field2"];// status of the power contactor
                    //    console.log(Channel_1_ContactorStatus);

                        if (Channel_1_ContactorStatus == 0) document.getElementById("txPowerStatus").innerHTML = "O F F";
                        else if (Channel_1_ContactorStatus == 1) document.getElementById("txPowerStatus").innerHTML = "O N";

                        var Temp1 = obj["feeds"][1]["field3"];
                        var Temp11 = Math.round((Temp1*100000)/100000);
                        var Temp3 = " C";
                        var Temp1 = Temp11 + " " + Temp3;
                        if(Temp11 == 0)Temp1 = "";

                        var Temp2 = obj["feeds"][1]["field4"];
                        var Temp22 = Math.round((Temp2*100000)/100000);
                        var Temp3 = " %";
                        var Temp2 = Temp22 + " " + Temp3;
                        if(Temp22 == 0)Temp2 = "";

                        document.getElementById("tempStatus").innerHTML = Temp1;
                        document.getElementById("rhStatus").innerHTML = Temp2;

                        ButtonEnableDisable();
                    }
                )
        }


        ///////////////////////Writing to ThingSpeak////////////////////////////

        function TxSwitchON() {
            API_TX_Switch(0);
        }

        function TxSwitchOFF() {
            API_TX_Switch(1);
        }

        function API_TX_Switch(onOrOff) {
            fetch(`https://api.thingspeak.com/update?api_key=FYHD918T4ZH50R1A&field1=${onOrOff}`)
                .then(response => response.text())
                .then(data => {
                        // document.getElementById("txPowerStatus").innerHTML = data;
                      //   console.log(data);
                        if (data == 0) alert("Command failed.  Retry once again after 20 seconds");
                          else alert("Command Success!! Wait for 20 seconds for the switching to take place")
                    }
                )
                .catch((error) => {
                        console.error('Error:', error);
                    }
                );

        }
</script>

</head>

<div class="container-fluid">

<body class="d-flex flex-column min-vh-100">  <!>


    <div class="row top-buffer"> <! Creates headings>
        <div class="col">
            <h1 class="display-4 text-center">Transmitter Automation</h1>
            <h1 class="display-6 text-center">IoT Cloud Application using ThingSpeak platform</h1>
        </div>
    </div>




    <div class="row top-buffer"> <! Creates buttons for the switching>
            <div class="col-md-12 text-center">
                <button id="onbtn" type="button" class="btn btn-primary" disabled onclick={TxSwitchOFF(this)}>TURN
                    Transmitter OFF
                </button>
                <button id="offbtn" type="button" class="btn btn-primary" disabled onclick={TxSwitchON(this)}>TURN
                    Transmitter ON
                </button>
            </div>
      </div>




    <div class="row top-buffer ">  <!Creates table for the the Transmitter status display>
        <div class="col"></div>
        <div class="col">

            <table class="table text-center">
                <tbody>
                <tr class="table-danger">
                    <th scope="row">Transmitter status:</th>
                    <td id="txPowerStatus"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="col"></div>
  </div>



  <div class="row top-buffer ">  <!Creates table for the the Transmitter status display>
      <div class="col"></div>
      <div class="col">

    <table class="table table-bordered  text-center">
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Outdoor</th>
          <th>Room</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Temperature</td>
          <td></td>
          <td id="tempStatus"></td>
        </tr>
        <tr>
          <td>Relative Humidity</td>
          <td></td>
          <td id="rhStatus"></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="col"></div>
</div>



<div class="row top"> <! Creates button for Modal for Matlab graphics>

    <div class="col">
          <div class="col-md-12 text-center">

          <a href="#TempRHModal" role="button" class="btn btn-success" data-toggle="modal"><small>Graph: Temp/RH vs Time</small></a>
          <a href="#TxSwitchingModal" role="button" class="btn btn-success" data-toggle="modal"><small>Graph: Tx Status vs Time</small></a>

          </button>
        </div>
    </div>
</div>



<div class="bs-example">  <!-- Modal and iframe for Temp and RH Graphics -->

    <div id="TempRHModal" class="modal fade">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body mb-0 p-0>
                  <div class="embed-responsive embed-responsive-16by9">
                    <iframe id="TempRHGraphics" class="embed-responsive-item" width="360" height="300" src="https://thingspeak.com/apps/matlab_visualizations/412315?width=360&height=300" allowfullscreen></iframe>
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="bs-example">  <!-- Modal and iframe for Transmitter switching graphics -->

    <div id="TxSwitchingModal" class="modal fade">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body mb-0 p-0>
                  <div class="embed-responsive embed-responsive-16by9">
                    <iframe id="TxSwitchingGraphics" class="embed-responsive-item" width="360" height="300" src="https://thingspeak.com/apps/matlab_visualizations/413731?width=360&height=300" allowfullscreen></iframe>
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>





        <footer class="footer py-3 bg-light mt-auto">
            <div class="container text-center">
                <span class="text-muted">Built by Varpas Media Technologies Pvt Ltd</span>
            </div>
        </footer>


</div>



</body>
</html>
